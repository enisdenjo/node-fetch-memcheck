name: CI

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 21
      - name: Install
        run: npm ci
      - name: Download k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1
      - name: Up
        run: |
          docker compose up httpbin native -d
      - name: Load
        env:
          PORT: 3000
        run: |
          ./k6 run k6.js --vus=5 --duration=30s
          curl http://localhost:$PORT/gc
      - name: Stats
        run: docker stats --format json --no-stream
